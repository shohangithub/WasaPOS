@model IList<Model.Entities.Tbl_User>
@{
    ViewBag.Title = "User";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="right_col" role="main">
    <div class="">
        <div class="clearfix" id="succMsg" style="text-align:center;padding-top:7px;"></div>
        <div class="row">            
            <div class="col-md-12 col-sm-12 col-xs-12">
                <div class="x_panel">
                    <div class="x_title">
                        <h2>Add User<small>Create new User</small></h2>
                        <div class="clearfix"></div>
                    </div>
                    <div class="x_content" id="contactFormArea">
                        <br />
                        <form id="mainform" data-parsley-validate class="form-horizontal form-label-left">
                            <div class="form-group">
                                @Html.Hidden("UserId")
                                @Html.Hidden("OfficeCode")  
                           
                            </div>
                            @*<div class="form-group">
                                <label class="control-label col-md-3 col-sm-3 col-xs-12" for="last-name">
                                    Branch
                                </label>
                                <div class="col-md-6 col-sm-6 col-xs-12">
                                    @Html.DropDownList("BranchId", (SelectList)ViewBag.UserOffice, "Select", new { @class = "form-control" })
                                </div>
                            </div>*@
                            <div class="form-group">
                                <label class="control-label col-md-3 col-sm-3 col-xs-12" for="last-name">
                                    User Role
                                </label>
                                <div class="col-md-6 col-sm-6 col-xs-12">
                                    @Html.DropDownList("RoleId", (SelectList)ViewBag.UserRole, "Select", new { @class = "form-control" })
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-md-3 col-sm-3 col-xs-12" for="first-name">
                                    User Email <span class="required">*</span>
                                </label>
                                <div class="col-md-6 col-sm-6 col-xs-12">
                                    @Html.TextBox("UserEmail", null, new { @class = "form-control col-md-7 col-xs-12", required = "required" })
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-md-3 col-sm-3 col-xs-12" for="first-name">
                                    User Name <span class="required">*</span>
                                </label>
                                <div class="col-md-6 col-sm-6 col-xs-12">
                                    @Html.TextBox("UserName", null, new { @class = "form-control col-md-7 col-xs-12", required = "required" })
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-md-3 col-sm-3 col-xs-12" for="first-name">
                                    Password <span class="required">*</span>
                                </label>
                                <div class="col-md-6 col-sm-6 col-xs-12">
                                    @Html.Password("UserPassword",null, new { @class = "form-control col-md-7 col-xs-12", required = "required" })
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-md-3 col-sm-3 col-xs-12" for="first-name">
                                    ConfirmPassword <span class="required">*</span>
                                </label>
                                <div class="col-md-6 col-sm-6 col-xs-12">
                                    @Html.Password("ConfirmPassword", "", new { @class = "form-control col-md-7 col-xs-12", required = "required" })
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-md-3 col-sm-3 col-xs-12 control-label">
                                    Status <span class="required">*</span>
                                </label>
                                <div class="col-md-6 col-sm-6 col-xs-12 ">
                                   <select id="Status" name="Status" class="form-control">
                                       <option>Active</option>
                                       <option>Inactive</option>
                                   </select>

                                        @*@Html.RadioButtonFor(x => x.Status, true, new { id = "radio1" })
                                        <label for="radio1"><i class="fa fa-check" aria-hidden="true"></i></label>
                                        @Html.RadioButtonFor(x => x.Status, false, new { id = "radio2" })
                                        <label for="radio2"><i class="fa fa-circle-thin" aria-hidden="true"></i></label>*@

                                    </div>
                                </div>

                    <div class="form-group">
                        <div class="col-md-6 col-sm-6 col-xs-12 col-md-offset-4">
                            <button type="button" class="btn btn-primary" id="updateBtn" onclick="UpdateUser()">Update</button>
                            <button type="button" class="btn btn-success" id="btnSubmit" onclick="SetUser()">Submit</button>
                        </div>
                    </div>
                        </form>
                    </div>

                </div>
            </div>
            <div class="clearfix"></div>
            <div class="col-md-12 col-sm-12 col-xs-12">
                <div class="x_panel">
                    <div class="x_content" id="tableSection">
                        <div class="row">
                            <div class="col-xs-12">

                                <div class="clearfix">
                                    <div class="pull-right tableTools-container"></div>
                                </div>
                                <div class="table-header btn-custom">
                                    Existing User
                                </div>

                                <div id="after_create">
                                    <table id="dynamic-table" class="table table-striped table-bordered table-hover">
                                        <thead>
                                            <tr>
                                                <th>User ID</th>
                                                <th>User Name</th>
                                                <th>User Role</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>

                                        <tbody>
                                            @if (Model.Count() > 0)
                                            {
                                                foreach (var item in Model)
                                                {
                                                    <tr>
                                                        <td>@item.UserId</td>
                                                        <td>@item.UserName</td>
                                                        <td>@item.Tbl_UserRole.RoleName</td>
                                                        <td>
                                                            <a class="green" style="cursor:pointer" onclick="Edit('@item.UserId','@item.UserEmail','@item.UserName','','@item.RoleId','@item.Status')">
                                                                <i class="ace-icon fa fa-pencil bigger-130"></i>
                                                            </a>
                                                            <a class="red" style="cursor:pointer" onclick="DeleteUser('@item.UserId')">
                                                                <i class="ace-icon fa fa-trash-o bigger-130"></i>
                                                            </a>
                                                        </td>

                                                    </tr>
                                                }
                                            }
                                            else
                                            {
                                                <tr>
                                                    <td class="number" colspan="6"><h4>No Data Available!</h4></td>
                                                </tr>
                                            }


                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@section scripts{
    <script type="text/javascript">
        function SetUser() {

       // var OfficeCode = $("#OfficeCode").val();
        var RoleId = $("#RoleId").val();
        var UserName = $("#UserName").val();
        var UserEmail = $("#UserEmail").val();
        var UserPassword = $("#UserPassword").val();
        var ConfirmPassword = $("#ConfirmPassword").val();
        var Status = $("#Status").val();

        

        if (RoleId == "") {
            alert("Role is required.");
        }
        //else if (OfficeCode == "") {
        //    alert("Branch is required.");
        //}
        else if (UserEmail == "") {
            alert("User Email is required.");
        }
        else if (UserName=="") {
            alert("UserName is required.");
        }
        else if (UserPassword == "") {
            alert("Please set password.");
        } else if (ConfirmPassword == "") {
            alert("Please Confirm password.");
        } else if (Status == "") {
            alert("Status is required.");
        }
        else {

            var data = {
                //OfficeCode:"",
                RoleId: RoleId,
                UserName: UserName,
                UserEmail: UserEmail,
                UserPassword: UserPassword,
                Status: Status
            };
            $.ajax({
                type: "POST",
                url: "../Security/AddUser",
                data: JSON.stringify(data),
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                cache: false,
                success: function (data, textStatus, jqXHR) {
                    $("#dialogSupplier").dialog('close');
                    alert(data.message);
                    //$('#after_create').load('@Url.Action("UserList", "Security")');
                    $("#OfficeCode").val("");
                    $("#RoleId").val("");
                    $("#UserName").val("");
                    $("#UserEmail").val("");
                    $("#UserPassword").val("");
                    $("#ConfirmPassword").val("");
                    $("#Status").val("");

                    window.location.reload();
                },
                error: function () {
                    alert('User Creation Failed!');
                }
            });
        }
    }

        function Edit(UserId, UserEmail, UserName, OfficeCode,RoleId, Status) {
       // data = '<input type="hidden" id="UserId" value="' + UserId + '">';
        data2='<span>Old Password<span style="color:#cc0000">*</span></span>'+
              '<div class="left" style="width: 70%;">'+
                  '<input name="Oldpassword" type="password" id="Oldpassword" class="required" placeholder="" autofocus="" />' +
                  '</div>';

      //  $("#hidden_area").html(data);
        $("#hiddenOldPassword").html(data2);
        $('#lblnewpassword').html('New Password<span style="color:#cc0000">*</span>');
        $("#UserId").val(UserId);
        $("#OfficeCode").val(OfficeCode);
        $("#RoleId").val(RoleId);
        $("#UserEmail").val(UserEmail);
        $("#UserName").val(UserName);
        $("#Status").val(Status);
        $("#UserPassword").val("");
        $("#ConfirmPassword").val("");

        $("#btnSubmit").hide();
        $("#updateBtn").show();
    }

    function UpdateUser() {
        var OfficeCode = $("#OfficeCode").val();
        var UserId = $("#UserId").val();
        var RoleId = $("#RoleId").val();
        var UserName = $("#UserName").val();
        var UserEmail = $("#UserEmail").val();
        var UserPassword = $("#UserPassword").val();
        var ConfirmPassword = $("#ConfirmPassword").val();
        //var Oldpassword = $("#Oldpassword").val();
        var Status = $("#Status").val();

        if (RoleId == "") {
            alert("Role is required.");
        }
        //else if (OfficeCode == "") {
        //    alert("Branch is required.");
        //}
        else if (UserName == "") {
            alert("UserName is required.");
        }
        else if (UserEmail == "") {
            alert("User Email is required.");
        }
        //else if (Oldpassword == "") {
        //    alert("Please set old password.");
        //}
        else if (UserPassword == "") {
            alert("Please set password.");
        } else if (ConfirmPassword == "") {
            alert("Please Confirm password.");
        }
     else if (Status == "") {
        alert("Status is required.");
    }
        else {
         var data = {
                OfficeCode:OfficeCode,
                UserId: UserId,
                RoleId: RoleId,
                UserName: UserName,
                UserEmail: UserEmail,
                UserPassword: UserPassword,
                Oldpassword: ConfirmPassword,
                Status: Status
            };
            $.ajax({
                type: "POST",
                url: "../Security/UpdateUser",
                data: JSON.stringify(data),
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                cache: false,
                success: function (data) {
                    alert(data.message);
                    $("#dialogSupplier").dialog('close');
                    $("#OfficeCode").val("");
                    $("#UserId").val("");
                    $("#RoleId").val("");
                    $("#UserEmail").val("");
                    $("#UserName").val("");
                    $("#UserPassword").val("");
                    $("#ConfirmPassword").val("");
                    $("#Status").val("");
                    window.location.reload();
                },
                error: function () {
                    alert('Update Operation Failed!');
                }
            });
        }
    }

    function DeleteUser(UserId) {
        if (confirm('Are you sure to delete record?')) {
            var data = {
                UserId: UserId
            };

            $.ajax({
                type: "POST",
                url: "../Security/DeleteUser",
                data: JSON.stringify(data),
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                cache: false,
                success: function (data, textStatus, jqXHR) {
                    alert(data.message);
                    @*$('#after_create').load('@Url.Action("UserList", "Security")');*@
                    $("#btnSubmit").show();
                    $("#updateBtn").hide();
                    window.location.reload();
                },
                error: function () {
                    $("#setoffice").show();
                    $("#updateoffice").hide();
                    alert('Deleted Failed!');
                }
            });
        }
    }


        $(document).on("blur", "#ConfirmPassword", function () {
            var pass = $("#UserPassword").val();
            var pass1 = $("#ConfirmPassword").val();
            if (pass != pass1) {
                alert("Please Confirm Password.");
                $("#ConfirmPassword").val("");
            }
        });
        $(document).on("blur", "#Oldpassword", function () {
            var value = $("#Oldpassword").val();
            var userId = $("#UserId").val();
            var data = {
                UserId: userId,
                password: value
            };

            $.ajax({
                type: "POST",
                url: "../Security/CheckOldPassword",
                data: JSON.stringify(data),
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                cache: false,
                success: function (success, textStatus, jqXHR) {
                    if (success == true) {

                    } else {
                        $("#Oldpassword").val("");
                        alert("Old Password is wrong !");
                    }

                },
                error: function () {
                    $("#setoffice").show();
                    $("#updateoffice").hide();
                    alert('Deleted Failed!');
                }
            });
        });
    </script>
}




